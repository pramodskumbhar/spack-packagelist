# axis that defines software deployment strategy
axis:
  - architecture
  - compiler
  - mpi
  - lapack
  - python

# software combinations from defined axis
combinations:

  gnu48:
    architecture:
    - linux-rhel7-x86_64
    compiler:
    - gcc@4.8.5
    mpi: None
    lapack: None
    python: None

  gnu62:
    architecture:
      - linux-rhel7-x86_64
    compiler:
      - gcc@6.2.0
    mpi:
      - 'mvapich2@2.2~cuda fabrics=mrail process_managers=slurm threads=multiple'
    lapack:
      - 'openblas@0.2.20~openmp : openblas@0.2.20+openmp'
    python:
      - 'python@3.6.3 : python@2.7.14'

  intel18:
    architecture:
      - linux-rhel7-x86_64
    compiler:
      - intel@18.0.1
    mpi:
      - intel-mpi@2018.1.163
    lapack:
      - 'intel-mkl+openmp : intel-mkl~openmp'
    python:
      - python@3.6.3:python@2.7.14

  pgi17:
    architecture:
      - linux-rhel7-x86_64
    compiler:
      - pgi@17.10
    mpi:
      - 'mvapich2@2.2~cuda fabrics=mrail process_managers=slurm threads=multiple'
    lapack: None
    python: None

  llvm4:
    architecture:
      - linux-rhel7-x86_64
    compiler:
      - clang@4.0.1
    mpi:
      - 'mvapich2@2.2~cuda fabrics=mrail process_managers=slurm threads=multiple'
    lapack: None
    python: None

  gnu72:
    architecture:
      - linux-rhel7-x86_64
    compiler:
      - gcc@7.2.0
    mpi: None
    lapack: None
    python: None

packages:

  core-packages:
    target_matrix:
      - gnu48
    requires:
      - architecture
      - compiler
    specs:
      - cmake@3.8.2
      - cmake@3.1.0
      - scala@2.12.1
      - darshan-util
      - allinea-forge
      - valgrind@3.13.0~boost~mpi
      - antlr

  gnu-packages:
    target_matrix:
      - gnu62
    requires:
      - architecture
      - compiler
    specs:
      - boost@1.57.0~mpi~python
      - boost@1.66.0+python^python@2.7.14
      - python@2.7.14
      - python@3.6.3
      - libxml2
      - zlib
      - zeromq
      - qt@4.8.6
      - qt@5.10.0
      - cube+gui
      - spark@2.2.0+hadoop
      - iozone
      - ompt-openmp
      - ravel
      - raja
      - kokkos

  gnu-mpi-packages:
    target_matrix:
      - gnu62
    requires:
      - architecture
      - compiler
      - mpi
    specs:
      - adios+mpi
      - adios2+mpi
      - paraview+mpi
      - stat

  gnu-mpi-lapack:
    target_matrix:
      - gnu62
    requires:
      - architecture
      - compiler
      - mpi
      - lapack
    specs:
      - netlib-scalapack@2.0.2

  gnu-lapack-serial:
    target_matrix:
      - gnu62
    target_filter:
      lapack: ['openblas@0.2.20~openmp']
    requires:
      - architecture
      - compiler
      - lapack
    specs:
      - octave

  gnu-petsc-mpi-lapack:
    target_matrix:
      - gnu62
    requires:
      - architecture
      - compiler
      - mpi
      - lapack
    specs:
      - petsc@3.6.3+boost+double+hdf5+metis+mpi+mumps~superlu-dist~hypre
      - openspeedshop+mvapich2

  gnu-cuda-packages:
    target_matrix:
      - gnu62
    requires:
      - architecture
      - compiler
    specs:
      - cuda@9.1.85
      - cuda@8.0.61
      - cuda@6.5.14

  gnu-cudnn:
    target_matrix:
      - gnu62
    requires:
      - architecture
      - compiler
    specs:
      - cudnn@6.0 ^cuda@9.1.85
      - cudnn@6.0 ^cuda@8.0.44

  mpi-per-compiler:
    target_matrix:
      - gnu62
      - intel18
      - pgi17
    requires:
      - architecture
      - compiler
      - mpi
    specs:
      - hdf5@1.8.16+mpi~cxx~fortran+szip
      - hdf5@1.10.1+mpi~cxx~fortran+szip

  mpi-libs-per-compiler:
    target_matrix:
      - gnu62
      - intel18
      - pgi17
      - llvm4
    requires:
      - architecture
      - compiler
    specs:
      - mvapich2@2.2~cuda fabrics=mrail process_managers=slurm threads=multiple ^libpciaccess%gcc
      - intel-mpi@2018.1.163

  perftools-per-compiler:
    target_matrix:
      - gnu62
      - intel18
      - pgi17
      - llvm4
    requires:
      - architecture
      - compiler
      - mpi
    specs:
      - tau@2.26.3+mpi
      - darshan-runtime@3.1.0

  # no pgi fortran license at bbp
  extra-perftools-per-compiler:
    target_matrix:
      - gnu62
      - intel18
    requires:
      - architecture
      - compiler
      - mpi
    specs:
      - scorep@3.1^papi%gcc^cube%gcc
      - hpctoolkit@master+mpi ^hpctoolkit-externals@masters%gcc
      - caliper
      - extrae
      - mpileaks
      - mpip

  python-scientific-lapack:
    target_matrix:
      - gnu62
      - intel18
    target_filter:
      lapack: ['openblas@0.2.20+openmp', 'openblas@0.2.20~openmp', 'intel-mkl+openmp']
    requires:
      - architecture
      - compiler
      - python
      - lapack
    specs:
      - py-numpy@1.13.3+blas+lapack
      - py-scipy@1.0.0^py-numpy+blas+lapack@1.13.3
